@(form: Form[_root_.ledger.LedgerEntryForm], running: Seq[(_root_.ledger.LedgerEntry, Double)], byType: Map[String, Double], balance: Double, credits: Double, debits: Double, txCount: Int, accounts: Seq[String], currentAccount: String)(implicit request: RequestHeader)

@main("Ledger - Event Sourcing") {
    <h1>Financial Ledger</h1>

    <div class="concept-banner">
        <h3>Advanced Concepts: Event Sourcing, foldLeft, scanLeft, Immutability, groupMapReduce</h3>
        <p>Entries are append-only (immutable history). The current balance is derived by folding over the entire transaction history. Running balances use <code>scanLeft</code>. No entry is ever edited or deleted.</p>
        <pre><code>// Event sourcing: current state derived from folding over history
def computeBalance(entries: Seq[LedgerEntry]): Double =
  entries.foldLeft(0.0) { (balance, entry) =&gt;
    entry.txType match
      case Credit | Refund =&gt; balance + entry.amount
      case Debit | Fee     =&gt; balance - entry.amount
  }

// Running balance at each point (scanLeft)
def runningBalances(entries: Seq[LedgerEntry]): Seq[(LedgerEntry, Double)] =
  entries.scanLeft((null, 0.0)) { case ((_, bal), entry) =&gt;
    entry.txType match
      case Credit | Refund =&gt; (entry, bal + entry.amount)
      case Debit | Fee     =&gt; (entry, bal - entry.amount)
  }.tail

// Grouping transactions
def summaryByType(entries: Seq[LedgerEntry]): Map[String, Double] =
  entries.groupMapReduce(_.txType)(_.amount)(_ + _)</code></pre>
    </div>

    @request.flash.get("success").map { message =>
        <div class="success">@message</div>
    }

    <h2>Add Transaction (append-only)</h2>
    @helper.form(action = _root_.ledger.routes.LedgerController.addEntry()) {
        @helper.CSRF.formField
        <div class="inline-form">
            <div class="form-group">
                <label for="accountName">Account</label>
                <input type="text" id="accountName" name="accountName" value="@form("accountName").value.getOrElse("Main Account")" required>
            </div>
            <div class="form-group">
                <label for="txType">Type</label>
                <select id="txType" name="txType">
                    <option value="Credit" @if(form("txType").value.contains("Credit")){selected}>Credit</option>
                    <option value="Debit" @if(form("txType").value.contains("Debit")){selected}>Debit</option>
                    <option value="Refund" @if(form("txType").value.contains("Refund")){selected}>Refund</option>
                    <option value="Fee" @if(form("txType").value.contains("Fee")){selected}>Fee</option>
                </select>
            </div>
            <div class="form-group">
                <label for="amount">Amount ($)</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01" value="@form("amount").value.getOrElse("")" required style="width:120px">
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" value="@form("description").value.getOrElse("")" required>
            </div>
            <div class="form-group">
                <button type="submit" class="btn-blue">Add Entry</button>
                <button type="button" class="btn-autofill btn-sm" onclick="autoFillLedger()">Auto Fill</button>
            </div>
        </div>
    }

    <script>
    function autoFillLedger() {
        var entries = [
            { account: 'Main Account', type: 'Credit', amount: 5000.00, desc: 'Monthly salary deposit - January 2025' },
            { account: 'Main Account', type: 'Debit', amount: 1250.00, desc: 'Rent payment - apartment lease' },
            { account: 'Main Account', type: 'Debit', amount: 89.99, desc: 'Electric utility bill - ConEd' },
            { account: 'Main Account', type: 'Fee', amount: 12.50, desc: 'Monthly account maintenance fee' },
            { account: 'Savings Account', type: 'Credit', amount: 1000.00, desc: 'Transfer from checking - emergency fund' },
            { account: 'Main Account', type: 'Refund', amount: 149.99, desc: 'Amazon return - defective headphones' },
            { account: 'Business Account', type: 'Credit', amount: 3200.00, desc: 'Client invoice payment - Project Alpha' },
            { account: 'Business Account', type: 'Debit', amount: 450.00, desc: 'Software license renewal - JetBrains' },
            { account: 'Business Account', type: 'Fee', amount: 29.99, desc: 'Payment processing fee - Stripe' },
            { account: 'Savings Account', type: 'Credit', amount: 250.00, desc: 'Interest payment - Q4 2024' }
        ];
        var e = entries[Math.floor(Math.random() * entries.length)];
        document.getElementById('accountName').value = e.account;
        document.getElementById('txType').value = e.type;
        document.getElementById('amount').value = e.amount;
        document.getElementById('description').value = e.desc;
    }
    </script>

    @if(accounts.nonEmpty) {
        <h2>Filter by Account</h2>
        <p>
            <a href="@_root_.ledger.routes.LedgerController.showLedger()" @if(currentAccount.isEmpty){ style="font-weight:bold" }>All</a>
            @for(acc <- accounts) {
                | <a href="?account=@acc" @if(currentAccount == acc){ style="font-weight:bold" }>@acc</a>
            }
        </p>
    }

    <div class="cards">
        <div class="card">
            <h3>Current Balance (<code>foldLeft</code>)</h3>
            <p style="font-size:1.8em; color:@{if(balance >= 0) "#4CAF50" else "#f44336"}"><strong>$@{f"${balance}%.2f"}</strong></p>
        </div>
        <div class="card">
            <h3>Total Credits</h3>
            <p style="font-size:1.3em; color:#4CAF50"><strong>$@{f"${credits}%.2f"}</strong></p>
        </div>
        <div class="card">
            <h3>Total Debits</h3>
            <p style="font-size:1.3em; color:#f44336"><strong>$@{f"${debits}%.2f"}</strong></p>
        </div>
        <div class="card">
            <h3>Transaction Count</h3>
            <p style="font-size:1.3em"><strong>@txCount</strong></p>
        </div>
    </div>

    @if(byType.nonEmpty) {
        <h2>By Type (<code>groupMapReduce</code>)</h2>
        <table>
            <thead><tr><th>Type</th><th>Total</th></tr></thead>
            <tbody>
                @for((txType, total) <- byType.toSeq.sortBy(_._1)) {
                    <tr><td>@txType</td><td>$@{f"${total}%.2f"}</td></tr>
                }
            </tbody>
        </table>
    }

    <h2>Transaction History with Running Balance (<code>scanLeft</code>)</h2>
    @if(running.isEmpty) {
        <p>No transactions yet. Add one above!</p>
    } else {
        <table>
            <thead><tr><th>ID</th><th>Account</th><th>Type</th><th>Amount</th><th>Description</th><th>Running Balance</th></tr></thead>
            <tbody>
                @for((entry, bal) <- running) {
                    <tr>
                        <td>@entry.id</td>
                        <td>@entry.accountName</td>
                        <td>@entry.txType</td>
                        <td style="color:@{if(entry.txType == "Credit" || entry.txType == "Refund") "#4CAF50" else "#f44336"}">
                            @{if(entry.txType == "Credit" || entry.txType == "Refund") "+" else "-"}$@{f"${entry.amount}%.2f"}
                        </td>
                        <td>@entry.description</td>
                        <td style="font-weight:bold; color:@{if(bal >= 0) "#4CAF50" else "#f44336"}">$@{f"${bal}%.2f"}</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
