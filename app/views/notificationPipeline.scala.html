@(form: Form[_root_.notifications.NotificationForm], result: Option[(Seq[_root_.notifications.PipelineStep], String)])(implicit request: RequestHeader)

@main("Notifications - Function Composition") {
    <h1>Notification Pipeline</h1>

    <div class="concept-banner">
        <h3>Concepts: Function Composition &mdash; andThen, compose, pipe, tap, PartialFunction, Currying</h3>
        <p>A notification passes through a pipeline of composed functions. Each stage transforms the notification, and routing uses <code>PartialFunction.orElse</code> to dispatch by channel.</p>

        <details class="code-callout">
            <summary>Pipeline Stages (Notification =&gt; Notification) <span class="callout-source">NotificationPipeline.scala</span></summary>
            <pre><code>// Individual pipeline stages as functions
val sanitize: Notification =&gt; Notification = n =&gt;
  n.copy(message = n.message.replaceAll("&lt;[^&gt;]*&gt;", "").trim)

val addTimestamp: Notification =&gt; Notification = n =&gt;
  n.copy(metadata = n.metadata + ("sentAt" -&gt; Instant.now.toString))

val truncate: Notification =&gt; Notification = n =&gt;
  if n.message.length &gt; 100 then n.copy(message = n.message.take(97) + "...") else n

// andThen - compose left to right
val pipeline: Notification =&gt; Notification = sanitize
  .andThen(addTimestamp)
  .andThen(truncate)</code></pre>
        </details>

        <details class="code-callout">
            <summary>PartialFunction &mdash; Channel Routing <span class="callout-source">NotificationPipeline.scala</span></summary>
            <pre><code>val emailHandler: PartialFunction[Notification, String] =
  case n if n.channel == "email" =&gt; s"Sending email to ${n.recipient}: ${n.message}"

val smsHandler: PartialFunction[Notification, String] =
  case n if n.channel == "sms" =&gt; s"Sending SMS to ${n.recipient}: ${n.message.take(160)}"

val pushHandler: PartialFunction[Notification, String] =
  case n if n.channel == "push" =&gt; s"Sending push to ${n.recipient}: ${n.message.take(80)}"

val route: PartialFunction[Notification, String] =
  emailHandler
    .orElse(smsHandler)
    .orElse(pushHandler)
    .orElse { case n =&gt; s"Unknown channel '${n.channel}' for ${n.recipient}" }</code></pre>
        </details>

        <details class="code-callout">
            <summary>Curried Functions &mdash; Reusable Formatters <span class="callout-source">NotificationPipeline.scala</span></summary>
            <pre><code>// Curried function for reusable formatters
def formatForChannel(maxLength: Int)(prefix: String)(n: Notification): Notification =
  n.copy(message = s"$prefix ${n.message}".take(maxLength))

val formatForSms: Notification =&gt; Notification = formatForChannel(160)("[SMS]")
val formatForEmail: Notification =&gt; Notification = formatForChannel(5000)("[Email]")
val formatForPush: Notification =&gt; Notification = formatForChannel(80)("[Push]")</code></pre>
        </details>
    </div>

    <h2>Send a Notification</h2>
    <p>Try including HTML tags like <code>&lt;b&gt;bold&lt;/b&gt;</code> or <code>&lt;script&gt;alert('hi')&lt;/script&gt;</code> to see sanitization. Try a long message (100+ chars) to see truncation.</p>

    @helper.form(action = _root_.notifications.routes.NotificationController.sendNotification()) {
        @helper.CSRF.formField

        <div class="form-group">
            <label for="channel">Channel</label>
            <select id="channel" name="channel">
                <option value="email" @if(form("channel").value.contains("email")){selected}>Email</option>
                <option value="sms" @if(form("channel").value.contains("sms")){selected}>SMS</option>
                <option value="push" @if(form("channel").value.contains("push")){selected}>Push</option>
            </select>
        </div>

        <div class="form-group">
            <label for="recipient">Recipient</label>
            <input type="text" id="recipient" name="recipient" value="@form("recipient").value.getOrElse("")" placeholder="user@@example.com" required>
        </div>

        <div class="form-group">
            <label for="message">Message (try HTML tags and long text!)</label>
            <textarea id="message" name="message" rows="3" required>@form("message").value.getOrElse("")</textarea>
        </div>

        <div class="btn-group">
            <button type="submit" class="btn-blue">Process Notification</button>
            <button type="button" class="btn-autofill" onclick="autoFillNotification()">Auto Fill</button>
        </div>
    }

    <script>
    function autoFillNotification() {
        var notifications = [
            { ch: 'email', to: 'alice.johnson@@example.com', msg: 'Your order <b>#1042</b> has shipped! <a href="#">Track it here</a>. Expected delivery: 3-5 business days.' },
            { ch: 'sms', to: '+1-555-0101', msg: 'Hi Alice, your prescription is ready for pickup at Walgreens on Main St. Reply STOP to unsubscribe.' },
            { ch: 'push', to: 'bob.martinez', msg: 'Flash sale! <strong>50% off</strong> all electronics for the next 2 hours. <iframe onload="alert(1)"></iframe> Shop now!' },
            { ch: 'email', to: 'carol.chen@@techcorp.io', msg: 'Your return for Order #987 has been processed. A refund of $49.99 will appear on your statement within 5-7 business days. Thank you for shopping with us and we hope to see you again soon!' },
            { ch: 'sms', to: '+44-20-7946-0958', msg: 'Delivery update: Your package is <em>out for delivery</em> and will arrive by 5pm today.' },
            { ch: 'push', to: 'david.kim', msg: 'Price drop alert! The <b>Wireless Headphones</b> in your wishlist just dropped from $349 to $279.' }
        ];
        var n = notifications[Math.floor(Math.random() * notifications.length)];
        document.getElementById('channel').value = n.ch;
        document.getElementById('recipient').value = n.to;
        document.getElementById('message').value = n.msg;
    }
    </script>

    @result.map { case (steps, routed) =>
        <h2>Pipeline Steps</h2>

        @for(step <- steps) {
            <div class="step">
                <strong>@step.name</strong>
                <table style="margin-top:4px">
                    <tr>
                        <td style="width:60px;color:#999">Before:</td>
                        <td><code>@step.before.message</code></td>
                    </tr>
                    <tr>
                        <td style="color:#999">After:</td>
                        <td><code>@step.after.message</code></td>
                    </tr>
                    @if(step.after.metadata != step.before.metadata) {
                        <tr>
                            <td style="color:#999">Meta:</td>
                            <td><code>@step.after.metadata.mkString(", ")</code></td>
                        </tr>
                    }
                </table>
            </div>
        }

        <div class="card" style="margin-top:16px">
            <h3>Final Output (<code>PartialFunction.orElse</code> routing)</h3>
            <p>@routed</p>
        </div>
    }
}
