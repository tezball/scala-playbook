@(form: Form[_root_.orders.OrderForm], orderList: Seq[_root_.orders.Order], kafkaEvents: Seq[_root_.orders.OrderPlacedEvent])(implicit request: RequestHeader)

@main("Place Order") {
    <h1>Place Order</h1>

    <div class="concept-banner">
        <h3>Advanced Concepts: Kafka Producer/Consumer, Event Serialization, JSON Formats, Async Messaging</h3>
        <p>When an order is placed, an <code>OrderPlacedEvent</code> is published to Kafka. A background consumer thread reads events and displays them below. This demonstrates event-driven architecture with typed JSON serialization using Play's <code>Format</code> type class.</p>
        <pre><code>// Event case class with JSON Format (type class instance via given)
case class OrderPlacedEvent(eventType: String, timestamp: String, order: OrderPayload)
object OrderPlacedEvent:
  given Format[OrderPlacedEvent] = Json.format[OrderPlacedEvent]

// Publish to Kafka after DB write
kafkaProducer.publish(topic, order.id.toString, Json.toJson(event).toString())

// Consumer polls in a background thread
val records = consumer.poll(Duration.ofMillis(500))
for record &lt;- records.asScala do
  Json.parse(record.value()).validate[OrderPlacedEvent]</code></pre>
    </div>

    @request.flash.get("success").map { message =>
        <div class="success">@message</div>
    }

    @helper.form(action = orders.routes.OrderController.placeOrder()) {
        @helper.CSRF.formField

        <div class="form-group">
            <label for="userName">Your Name</label>
            <input type="text" id="userName" name="userName" value="@form("userName").value.getOrElse("")" required>
            @form.error("userName").map { error =>
                <div class="error-msg">@error.message</div>
            }
        </div>

        <div class="form-group">
            <label for="itemName">Item</label>
            <input type="text" id="itemName" name="itemName" value="@form("itemName").value.getOrElse("")" required>
            @form.error("itemName").map { error =>
                <div class="error-msg">@error.message</div>
            }
        </div>

        <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" value="@form("quantity").value.getOrElse("1")" min="1" required>
            @form.error("quantity").map { error =>
                <div class="error-msg">@error.message</div>
            }
        </div>

        <button type="submit" class="btn-blue">Place Order</button>
    }

    <h2>Orders</h2>
    @if(orderList.isEmpty) {
        <p>No orders placed yet.</p>
    } else {
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Item</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody>
                @for(order <- orderList) {
                    <tr>
                        <td>@order.id</td>
                        <td>@order.userName</td>
                        <td>@order.itemName</td>
                        <td>@order.quantity</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <h2>Checkout Emails (Kafka Events)</h2>
    @if(kafkaEvents.isEmpty) {
        <p>No checkout emails queued yet.</p>
    } else {
        <table>
            <thead>
                <tr>
                    <th>Event Type</th>
                    <th>Timestamp</th>
                    <th>Order ID</th>
                    <th>Name</th>
                    <th>Item</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody>
                @for(event <- kafkaEvents) {
                    <tr>
                        <td>@event.eventType</td>
                        <td>@event.timestamp</td>
                        <td>@event.order.id</td>
                        <td>@event.order.userName</td>
                        <td>@event.order.itemName</td>
                        <td>@event.order.quantity</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
