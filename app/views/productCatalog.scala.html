@(form: Form[_root_.products.ProductForm], productList: Seq[_root_.products.Product])(implicit request: RequestHeader)

@main("Products - Pattern Matching") {
    <h1>Product Catalog</h1>

    <div class="concept-banner">
        <h3>Concepts: Pattern Matching, Sealed Traits, Enums, Case Classes</h3>
        <p>Product pricing is computed using pattern matching on sealed trait discount types and enum categories. The compiler enforces exhaustive matching &mdash; every case must be handled.</p>

        <details class="code-callout">
            <summary>Enum + Sealed Trait ADT <span class="callout-source">PricingEngine.scala</span></summary>
            <pre><code>// Enum for product categories
enum Category:
  case Electronics, Books, Clothing, Food, Sports

// Sealed trait for discount types - each is a different "shape"
sealed trait Discount
case class Percentage(percent: Double) extends Discount
case class FixedAmount(amount: Double) extends Discount
case class BuyOneGetOne(freeItemName: String) extends Discount
case object NoDiscount extends Discount</code></pre>
        </details>

        <details class="code-callout">
            <summary>Pattern Matching &mdash; Discount + Tax Rules <span class="callout-source">PricingEngine.scala</span></summary>
            <pre><code>// Pattern matching to calculate final price
def applyDiscount(price: Double, discount: Discount): Double = discount match
  case Percentage(pct)  =&gt; price * (1 - pct / 100)
  case FixedAmount(amt) =&gt; (price - amt).max(0)
  case BuyOneGetOne(_)  =&gt; price  // price unchanged, but you get a free item
  case NoDiscount       =&gt; price

// Pattern matching on category for tax rates
def taxRate(category: Category): Double = category match
  case Category.Food                          =&gt; 0.0
  case Category.Books                         =&gt; 0.05
  case Category.Clothing                      =&gt; 0.08
  case Category.Electronics | Category.Sports =&gt; 0.10</code></pre>
        </details>

        <details class="code-callout">
            <summary>Final Price Computation <span class="callout-source">PricingEngine.scala</span></summary>
            <pre><code>def computeFinalPrice(basePrice: Double, category: Category, discount: Discount): Double =
  val afterDiscount = applyDiscount(basePrice, discount)
  val tax = taxRate(category)
  val finalPrice = afterDiscount * (1 + tax)
  BigDecimal(finalPrice).setScale(2, BigDecimal.RoundingMode.HALF_UP).toDouble</code></pre>
        </details>
    </div>

    @request.flash.get("success").map { message =>
        <div class="success">@message</div>
    }

    <h2>Add Product</h2>
    @helper.form(action = _root_.products.routes.ProductController.addProduct()) {
        @helper.CSRF.formField

        <div class="form-group">
            <label for="name">Product Name</label>
            <input type="text" id="name" name="name" value="@form("name").value.getOrElse("")" required>
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <select id="category" name="category">
                <option value="Electronics" @if(form("category").value.contains("Electronics")){selected}>Electronics (10% tax)</option>
                <option value="Books" @if(form("category").value.contains("Books")){selected}>Books (5% tax)</option>
                <option value="Clothing" @if(form("category").value.contains("Clothing")){selected}>Clothing (8% tax)</option>
                <option value="Food" @if(form("category").value.contains("Food")){selected}>Food (0% tax)</option>
                <option value="Sports" @if(form("category").value.contains("Sports")){selected}>Sports (10% tax)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="basePrice">Base Price ($)</label>
            <input type="number" id="basePrice" name="basePrice" step="0.01" min="0" value="@form("basePrice").value.getOrElse("0.00")" required>
        </div>

        <div class="form-group">
            <label for="discountType">Discount Type</label>
            <select id="discountType" name="discountType">
                <option value="none" @if(form("discountType").value.contains("none")){selected}>No Discount</option>
                <option value="percentage" @if(form("discountType").value.contains("percentage")){selected}>Percentage Off</option>
                <option value="fixed" @if(form("discountType").value.contains("fixed")){selected}>Fixed Amount Off</option>
                <option value="bogo" @if(form("discountType").value.contains("bogo")){selected}>Buy One Get One</option>
            </select>
        </div>

        <div class="form-group">
            <label for="discountValue">Discount Value (% or $ amount, 0 for BOGO/None)</label>
            <input type="number" id="discountValue" name="discountValue" step="0.01" min="0" value="@form("discountValue").value.getOrElse("0")" required>
        </div>

        <div class="btn-group">
            <button type="submit">Add Product</button>
            <button type="button" class="btn-autofill" onclick="autoFillProduct()">Auto Fill</button>
        </div>
    }

    <script>
    function autoFillProduct() {
        var products = [
            { name: 'MacBook Pro 16"', cat: 'Electronics', price: 2499.00, dtype: 'percentage', dval: 10 },
            { name: 'The Pragmatic Programmer', cat: 'Books', price: 49.99, dtype: 'none', dval: 0 },
            { name: 'Merino Wool Sweater', cat: 'Clothing', price: 89.00, dtype: 'fixed', dval: 15 },
            { name: 'Organic Avocados (6pk)', cat: 'Food', price: 8.99, dtype: 'bogo', dval: 0 },
            { name: 'Carbon Fiber Tennis Racket', cat: 'Sports', price: 199.99, dtype: 'percentage', dval: 20 },
            { name: 'Wireless Noise-Cancelling Headphones', cat: 'Electronics', price: 349.00, dtype: 'fixed', dval: 50 },
            { name: 'Running Shorts', cat: 'Clothing', price: 34.99, dtype: 'none', dval: 0 },
            { name: 'Scala 3 In Depth', cat: 'Books', price: 44.95, dtype: 'percentage', dval: 15 }
        ];
        var p = products[Math.floor(Math.random() * products.length)];
        document.getElementById('name').value = p.name;
        document.getElementById('category').value = p.cat;
        document.getElementById('basePrice').value = p.price;
        document.getElementById('discountType').value = p.dtype;
        document.getElementById('discountValue').value = p.dval;
    }
    </script>

    <h2>Products</h2>
    @if(productList.isEmpty) {
        <p>No products yet. Add one above!</p>
    } else {
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Base Price</th>
                    <th>Discount</th>
                    <th>Final Price</th>
                </tr>
            </thead>
            <tbody>
                @for(product <- productList) {
                    <tr>
                        <td>@product.id</td>
                        <td>@product.name</td>
                        <td>@product.category</td>
                        <td>$@{f"${product.basePrice}%.2f"}</td>
                        <td>@{product.discountType match {
                            case "percentage" => s"${product.discountValue}% off"
                            case "fixed" => s"$$${product.discountValue} off"
                            case "bogo" => "Buy One Get One"
                            case _ => "None"
                        }}</td>
                        <td><strong>$@{f"${product.finalPrice}%.2f"}</strong></td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
