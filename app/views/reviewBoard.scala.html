@(form: Form[_root_.reviews.ReviewForm], reviewList: Seq[_root_.reviews.Review], showOutput: Seq[String], currentSort: String)(implicit request: RequestHeader)

@main("Reviews - Traits + Type Classes") {
    <h1>Product Reviews</h1>

    <div class="concept-banner">
        <h3>Advanced Concepts: Traits, Mixins, Type Classes (Ordering, Show), Givens</h3>
        <p>Reviews mix in <code>Timestamped</code>, <code>Rateable</code>, and <code>Authorable</code> traits. Sorting uses <code>given Ordering[Review]</code> instances, and rendering uses a custom <code>Show</code> type class.</p>

        <details class="code-callout">
            <summary>Composable Traits + Mixin <span class="callout-source">Reviewable.scala, Review.scala</span></summary>
            <pre><code>// Composable traits
trait Timestamped:
  def createdAt: Instant

trait Rateable:
  def rating: Int
  def stars: String = "\u2605" * rating + "\u2606" * (5 - rating)

trait Authorable:
  def author: String

// Case class mixing in multiple traits
case class Review(id: Long, productName: String, author: String,
                  rating: Int, comment: String, createdAt: Instant)
  extends Timestamped, Rateable, Authorable</code></pre>
        </details>

        <details class="code-callout">
            <summary>Type Class: Show[A] + given Instance <span class="callout-source">Reviewable.scala, Review.scala</span></summary>
            <pre><code>// Custom type class: Show
trait Show[A]:
  def show(a: A): String

object Show:
  def apply[A](using s: Show[A]): Show[A] = s

// Using the type class with context bounds
def display[A](items: Seq[A])(using s: Show[A]): Seq[String] =
  items.map(s.show)

// Given instance for Review
given Show[Review] with
  def show(r: Review) = s"${r.stars} by ${r.author}: ${r.comment}"</code></pre>
        </details>

        <details class="code-callout">
            <summary>given Ordering Instances <span class="callout-source">Reviewable.scala</span></summary>
            <pre><code>// Custom Ordering instances (type class in action)
object ReviewOrderings:
  given byRating: Ordering[Review] = Ordering.by(r =&gt; (-r.rating, r.author))
  given byDate: Ordering[Review] = Ordering.by[Review, Instant](_.createdAt).reverse
  given byAuthor: Ordering[Review] = Ordering.by(_.author)</code></pre>
        </details>
    </div>

    @request.flash.get("success").map { message =>
        <div class="success">@message</div>
    }

    <h2>Write a Review</h2>
    @helper.form(action = _root_.reviews.routes.ReviewController.addReview()) {
        @helper.CSRF.formField

        <div class="form-group">
            <label for="productName">Product Name</label>
            <input type="text" id="productName" name="productName" value="@form("productName").value.getOrElse("")" required>
        </div>

        <div class="form-group">
            <label for="author">Your Name</label>
            <input type="text" id="author" name="author" value="@form("author").value.getOrElse("")" required>
        </div>

        <div class="form-group">
            <label for="rating">Rating (1-5)</label>
            <select id="rating" name="rating">
                @for(i <- 5 to 1 by -1) {
                    <option value="@i" @if(form("rating").value.contains(i.toString)){selected}>@i - @{"\u2605" * i + "\u2606" * (5 - i)}</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="comment">Comment</label>
            <textarea id="comment" name="comment" rows="2" required>@form("comment").value.getOrElse("")</textarea>
        </div>

        <div class="btn-group">
            <button type="submit" class="btn-orange">Submit Review</button>
            <button type="button" class="btn-autofill" onclick="autoFillReview()">Auto Fill</button>
        </div>
    }

    <script>
    function autoFillReview() {
        var reviews = [
            { product: 'MacBook Pro 16"', author: 'Alice Johnson', rating: 5, comment: 'Incredible performance for software development. The M3 chip handles sbt compilation like a breeze.' },
            { product: 'Wireless Mouse', author: 'Bob Martinez', rating: 3, comment: 'Decent mouse but the scroll wheel started squeaking after a month. Battery life is good though.' },
            { product: 'Standing Desk', author: 'Carol Chen', rating: 4, comment: 'Sturdy build quality and smooth height adjustment. Cable management could be better.' },
            { product: 'Noise-Cancelling Headphones', author: 'David Kim', rating: 5, comment: 'Best headphones I have ever owned. The noise cancellation is perfect for open offices.' },
            { product: 'Ergonomic Chair', author: 'Eva Rossi', rating: 2, comment: 'Lumbar support is uncomfortable and the armrests wobble. Not worth the premium price.' },
            { product: 'Mechanical Keyboard', author: 'Frank Okafor', rating: 4, comment: 'Great tactile feedback with Cherry MX Browns. A bit loud for shared workspaces.' },
            { product: 'USB-C Hub', author: 'Grace Liu', rating: 1, comment: 'Stopped working after two weeks. The HDMI port never detected my external monitor reliably.' },
            { product: '27" 4K Monitor', author: 'Henry Park', rating: 5, comment: 'Crystal clear text rendering makes code so much easier to read. Colors are accurate out of the box.' }
        ];
        var r = reviews[Math.floor(Math.random() * reviews.length)];
        document.getElementById('productName').value = r.product;
        document.getElementById('author').value = r.author;
        document.getElementById('rating').value = r.rating;
        document.getElementById('comment').value = r.comment;
    }
    </script>

    <h2>Reviews (sorted by <code>given Ordering</code>)</h2>
    <p>
        Sort by:
        <a href="?sort=rating" @if(currentSort == "rating"){ style="font-weight:bold" }>Rating</a> |
        <a href="?sort=date" @if(currentSort == "date"){ style="font-weight:bold" }>Date</a> |
        <a href="?sort=author" @if(currentSort == "author"){ style="font-weight:bold" }>Author</a>
    </p>

    @if(reviewList.isEmpty) {
        <p>No reviews yet. Be the first!</p>
    } else {
        <table>
            <thead><tr><th>Stars</th><th>Product</th><th>Author</th><th>Comment</th><th>Date</th></tr></thead>
            <tbody>
                @for(review <- reviewList) {
                    <tr>
                        <td>@review.stars</td>
                        <td>@review.productName</td>
                        <td>@review.author</td>
                        <td>@review.comment</td>
                        <td>@review.createdAt</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <h2><code>Show[Review]</code> Type Class Output</h2>
    @if(showOutput.isEmpty) {
        <p>No reviews to display.</p>
    } else {
        <ul>
            @for(line <- showOutput) {
                <li><code>@line</code></li>
            }
        </ul>
    }
}
